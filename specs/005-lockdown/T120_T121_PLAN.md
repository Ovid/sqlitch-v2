# T120 & T121 Implementation Plan: Type Safety & Linting Compliance# T120 & T121 Implementation Plan



**Status**: Planning Document  **Status**: Ready for systematic execution  

**Created**: 2025-10-12  **Created**: 2025-10-12  

**Baseline**: 62 mypy errors, 0 flake8 violations (T121 complete)**Priority**: P1 (both tasks block lockdown completion)



## Overview## Overview



This plan breaks down the remaining type safety work (T120) into granular, atomic tasks. T121 (flake8 compliance) is already complete with automated enforcement.Tasks T120 (mypy --strict) and T121 (flake8) require coordinated refactoring across

multiple CLI command modules. This document outlines a systematic approach to resolve

## Completed Work (Reference)all violations while maintaining test coverage and Sqitch parity.



### T121: Flake8 Compliance ✅## Current State (2025-10-12)

- All 59 violations eliminated

- Automated test added in `tests/test_formatting.py`### T120: mypy --strict backlog

- Zero violations maintained- **Total errors**: 76

- **Primary hotspots**:

### T120: Mypy Regression Guard ✅  - `sqlitch/config/loader.py` (2 errors): `optionxform` assignment type issues

- Baseline tracking implemented at 62 errors  - `sqlitch/registry/state.py` (4 errors): Missing generic type parameters for `tuple`

- Automated test added in `tests/test_type_safety.py`  - `sqlitch/engine/sqlite.py` (2 errors): Optional/Any type issues

- No new regressions allowed  - `sqlitch/plan/parser.py` (7 errors): Type incompatibility in change/tag parsing

  - `sqlitch/cli/options.py` (2 errors): Redundant casts

## Remaining Work: Eliminate 62 Mypy Errors  - `sqlitch/cli/commands/__init__.py` (1 error): Override signature mismatch

  - `sqlitch/utils/logging.py` (3 errors): Optional TextIO handling

### Error Breakdown by File (62 total)  - `sqlitch/config/resolver.py` (1 error): Optional path argument

  - `sqlitch/cli/main.py` (1 error): Unused type ignore comment

```  - `sqlitch/cli/commands/verify.py` (6 errors): EngineTarget vs str typing

sqlitch/cli/commands/deploy.py      : 5 errors  - `sqlitch/cli/commands/target.py` (10 errors): Method assignment issues (5 files × 2 each)

sqlitch/cli/commands/config.py      : 6 errors  - `sqlitch/cli/commands/status.py` (4 errors): Similar to verify.py

sqlitch/cli/commands/target.py      : 5 errors (optionxform assignment errors)  - `sqlitch/cli/commands/plan.py` (1 error): Path | str | None typing

sqlitch/cli/commands/verify.py      : 5 errors  - `sqlitch/cli/commands/help.py` (3 errors): BaseCommand type alias issues

sqlitch/cli/commands/show.py        : 5 errors  - `sqlitch/cli/commands/engine.py` (2 errors): Method assignment issues

sqlitch/cli/commands/rework.py      : 6 errors

sqlitch/cli/commands/revert.py      : 2 errors### T121: flake8 violations

sqlitch/cli/commands/status.py      : 3 errors- **Total violations**: 72 (reduced from 73)

sqlitch/cli/commands/engine.py      : 1 error (optionxform)- **Breakdown**:

sqlitch/cli/commands/help.py        : 3 errors  - 48× E501 (line too long) - primarily in `sqlitch/registry/migrations.py`

sqlitch/cli/commands/plan.py        : 1 error  - 14× F401 (unused imports) - scattered across CLI command modules

sqlitch/cli/commands/__init__.py    : 1 error  - 6× E203 (whitespace before ':') - black conflict, can be ignored

sqlitch/plan/parser.py              : 6 errors  - 3× F811 (redefinition) - `deploy.py` has duplicate helper imports

sqlitch/registry/state.py           : 4 errors  - 1× W293 (blank line with whitespace) - `registry/migrations.py`

sqlitch/engine/sqlite.py            : 2 errors

sqlitch/config/loader.py            : 1 error (optionxform)## Execution Strategy

sqlitch/config/resolver.py          : 1 error

sqlitch/utils/logging.py            : 3 errors### Phase 1: Quick Wins (Low Risk)

sqlitch/cli/options.py              : 2 errors1. **F401 (Unused Imports)** - Already started, 1/14 complete

sqlitch/cli/main.py                 : 1 error (unused ignore)   - Remove simple single-line unused imports

```   - Handle multi-import lines carefully (may need manual splitting)

   - Files affected: add.py, deploy.py, log.py, plan.py, revert.py, rework.py, tag.py, upgrade.py, verify.py

---   

2. **W293 (Whitespace)** - Trivial fix

## Phase 1: Quick Wins (7 errors) - Priority P1   - Remove trailing whitespace from `registry/migrations.py:191`

   

### T120a: Fix unused type:ignore comment in cli/main.py3. **E203 (Whitespace before ':')** - Configure flake8 to ignore

**File**: `sqlitch/cli/main.py:132`     - This is a known black/flake8 conflict

**Error**: `Unused "type: ignore" comment [unused-ignore]`     - Add to `.flake8` config: `ignore = E203`

**Fix**: Remove the unnecessary `# type: ignore` comment     - Affects: engine.py, sqlite.py, target.py (6 occurrences)

**Effort**: 5 minutes  

**Impact**: -1 error4. **F811 (Redefinition)** - Remove duplicate imports

   - `deploy.py:35` vs `deploy.py:903` - `generate_change_id`

### T120b: Fix redundant casts in cli/options.py (2 errors)   - `verify.py:12` vs `verify.py:83, :230` - `config_resolver`

**File**: `sqlitch/cli/options.py:153, 179`     - Check if the redefined versions are actually used

**Error**: `Redundant cast to "F" [redundant-cast]`  

**Fix**: Remove unnecessary `cast()` calls - the type is already correct  ### Phase 2: Type Safety (Medium Risk)

**Effort**: 10 minutes  5. **mypy: Simple type fixes**

**Impact**: -2 errors   - Remove redundant casts in `cli/options.py` (2 fixes)

   - Remove unused type ignore in `cli/main.py` (1 fix)

### T120c: Fix optionxform type:ignore comments to use assignment code (4 errors)   - Add generic parameters to `tuple` in `registry/state.py` (4 fixes)

**Files**:    - Fix Optional path argument in `config/resolver.py` (1 fix)

- `sqlitch/config/loader.py:94`   

- `sqlitch/cli/commands/target.py:64, 124, 168, 202, 232` (5 locations but 4 notes shown)6. **mypy: TextIO handling**

- `sqlitch/cli/commands/engine.py:265`   - `utils/logging.py` - properly handle Optional TextIO

- `sqlitch/cli/commands/config.py:394`   - May need assertion or early return pattern



**Current**: `# type: ignore[method-assign]`  ### Phase 3: Line Length (Low Risk, High Volume)

**Error**: `Error code "assignment" not covered by "type: ignore" comment`  7. **E501 (Line too long)** - 48 occurrences

**Fix**: Change to `# type: ignore[assignment,method-assign]` to cover both error codes     - **Strategy**: Use black/auto-formatting where possible

**Effort**: 15 minutes     - Most are in `registry/migrations.py` (SQL strings)

**Impact**: -4 errors (1 per file with "not covered" note)   - For SQL strings, consider using implicit string concatenation:

     ```python

---     # Before

     sql = "CREATE TABLE very_long_table_name (col1 TEXT, col2 TEXT, ...)"

## Phase 2: Registry State Type Annotations (4 errors) - Priority P1     

     # After

### T120d: Add tuple type parameters in registry/state.py (2 errors)     sql = (

**File**: `sqlitch/registry/state.py:45, 104`           "CREATE TABLE very_long_table_name "

**Error**: `Missing type parameters for generic type "tuple" [type-arg]`           "(col1 TEXT, col2 TEXT, ...)"

**Fix**: Change `tuple` to `tuple[type1, type2, ...]` with proper type parameters       )

**Effort**: 20 minutes (need to analyze tuple contents)       ```

**Impact**: -2 errors   - Or use `textwrap.dedent()` for readability



### T120e: Fix datetime type casts in registry/state.py (2 errors)### Phase 4: Complex Type Issues (High Risk)

**File**: `sqlitch/registry/state.py:304, 311`  8. **mypy: Target configuration typing**

**Error**: `Argument has incompatible type "object"; expected "datetime" [arg-type]`     - `cli/commands/target.py` - method assignment issues (10 errors)

**Fix**: Add proper type assertion/cast from object to datetime     - `cli/commands/verify.py` - EngineTarget vs str (6 errors)

**Effort**: 15 minutes     - `cli/commands/status.py` - similar issues (4 errors)

**Impact**: -2 errors   - **Root cause**: ConfigParser's `optionxform` is a method, can't reassign

   - **Solution**: Create wrapper class or use different approach

---

9. **mypy: Plan parser types**

## Phase 3: Plan Parser Type Fixes (6 errors) - Priority P1   - `plan/parser.py` - Change | Tag | None vs Change | None (7 errors)

   - May require refactoring parse logic or adding type narrowing

### T120f: Fix _parse_compact_entry last_entry type (3 errors)

**File**: `sqlitch/plan/parser.py:72, 81, 95`  10. **mypy: BaseCommand type alias**

**Error**: `Argument 4 has incompatible type "Change | Tag | None"; expected "Change | None"`      - `cli/commands/help.py` - variable vs type alias issues (3 errors)

**Fix**: Refactor `_parse_compact_entry` signature to accept `Change | Tag | None` OR add type narrowing guard      - May need to use proper type alias syntax

**Effort**: 30 minutes  

**Impact**: -3 errors## Testing Strategy



### T120g: Fix _parse_uuid None argument in parser.pyAfter each phase:

**File**: `sqlitch/plan/parser.py:161`  ```bash

**Error**: `Argument 1 has incompatible type "str | None"; expected "str"`  # Run affected module tests

**Fix**: Add None check before calling `_parse_uuid` or make function accept `str | None`  pytest tests/<module>/ -v

**Effort**: 15 minutes  

**Impact**: -1 error# Check mypy progress

mypy --strict sqlitch/ 2>&1 | wc -l

### T120h: Fix script_paths dict type variance in parser.py (2 errors)

**File**: `sqlitch/plan/parser.py:322, 324`  # Check flake8 progress

**Error**: `Incompatible dict types - dict[str, Path | None] vs dict[str, Path | str | None]`  flake8 sqlitch/ --count

**Fix**: Align dict type signatures between variable declaration and function parameter  

**Effort**: 25 minutes  # Ensure full test suite still passes

**Impact**: -2 errorspytest --no-cov -x

```

---

## Regression Guards

## Phase 4: SQLite Engine Type Safety (2 errors) - Priority P2

Once fixes are complete, add enforcement to prevent regressions:

### T120i: Fix SQLiteEngine._build_connect_arguments None handling

**File**: `sqlitch/engine/sqlite.py:44`  ### For mypy (T120)

**Error**: `Argument 1 has incompatible type "str | None"; expected "str"`  Create `tests/test_type_checking.py`:

**Fix**: Add None check before calling `_build_connect_arguments`  ```python

**Effort**: 15 minutes  def test_mypy_strict_compliance():

**Impact**: -1 error    """Ensure mypy --strict passes on all code."""

    result = subprocess.run(

### T120j: Fix SQLiteEngine.connect return type annotation        ["mypy", "--strict", "sqlitch/"],

**File**: `sqlitch/engine/sqlite.py:55`          capture_output=True,

**Error**: `Returning Any from function declared to return "Connection"`          text=True,

**Fix**: Add proper type annotation for Connection return type      )

**Effort**: 20 minutes      assert result.returncode == 0, f"mypy errors:\n{result.stdout}"

**Impact**: -1 error```



---### For flake8 (T121)

Create `tests/test_linting.py`:

## Phase 5: Config Module Type Fixes (2 errors) - Priority P2```python

def test_flake8_compliance():

### T120k: Fix config/resolver.py Path None handling    """Ensure flake8 passes on all code."""

**File**: `sqlitch/config/resolver.py:232`      result = subprocess.run(

**Error**: `Argument 1 to "Path" has incompatible type "str | PathLike[str] | None"`          ["flake8", "sqlitch/"],

**Fix**: Add None check before constructing Path          capture_output=True,

**Effort**: 15 minutes          text=True,

**Impact**: -1 error    )

    assert result.returncode == 0, f"flake8 violations:\n{result.stdout}"

### T120l: Fix config/config.py range() None arguments (4 errors)```

**File**: `sqlitch/cli/commands/config.py:456, 466, 473, 485`  

**Error**: `Argument 2 to "range" has incompatible type "int | None"`  ## Risk Mitigation

**Fix**: Add None checks or default values before range() calls  

**Effort**: 25 minutes  - **Commit frequently**: After each file or small group of related fixes

**Impact**: -4 errors- **Run tests after each fix**: Don't accumulate untested changes

- **Consult Sqitch source**: For any behavioral questions during refactoring

---- **Document type choices**: Add comments explaining complex type annotations

- **Keep diffs small**: Easier to review and revert if needed

## Phase 6: Logging Module Type Safety (3 errors) - Priority P2

## Estimated Effort

### T120m: Fix utils/logging.py TextIO assignment and usage (3 errors)

**File**: `sqlitch/utils/logging.py:272, 274, 275`  - **Phase 1 (Quick Wins)**: 1-2 hours

**Errors**:- **Phase 2 (Simple Types)**: 1-2 hours  

- Line 272: `Incompatible types in assignment (IO[str] vs TextIO | None)`- **Phase 3 (Line Length)**: 2-3 hours

- Line 274: `Item "None" has no attribute "write"`- **Phase 4 (Complex Types)**: 3-4 hours

- Line 275: `Item "None" has no attribute "flush"`- **Testing & Regression Guards**: 1 hour



**Fix**: Add proper None handling for TextIO operations  **Total**: 8-12 hours of focused work

**Effort**: 20 minutes  

**Impact**: -3 errors## Success Criteria



---- [X] T122: Bandit SHA1 warning resolved (complete)

- [X] T123: Automated black/isort enforcement (complete)

## Phase 7: Deploy Command Type Fixes (5 errors) - Priority P2- [ ] T120: `mypy --strict sqlitch/` exits with code 0

- [ ] T121: `flake8 sqlitch/` exits with code 0

### T120n: Fix deploy.py registry_uri None handling- [ ] All existing tests continue to pass

**File**: `sqlitch/cli/commands/deploy.py:276`  - [ ] New regression guard tests added

**Error**: `Argument "registry_uri" has incompatible type "str | None"; expected "str"`  - [ ] Tasks.md updated to mark T120 and T121 complete

**Fix**: Add None check before passing registry_uri  

**Effort**: 15 minutes  ## Notes

**Impact**: -1 error

- E203 (whitespace before ':') conflicts with black formatting

### T120o: Fix deploy.py target variable type assignment  - Solution: Configure flake8 to ignore E203

**File**: `sqlitch/cli/commands/deploy.py:421`    - This is a known and accepted conflict in the Python community

**Error**: `Incompatible types in assignment (str | None vs str)`    

**Fix**: Add assertion or type narrowing to prove target is not None  - ConfigParser `optionxform` reassignment is a common mypy pain point

**Effort**: 15 minutes    - Sqitch compatibility requires preserving key case

**Impact**: -1 error  - May need to create a helper wrapper or suppress specific lines



### T120p: Fix deploy.py dict type annotations (2 errors)- SQL string line lengths in migrations.py are the bulk of E501

**File**: `sqlitch/cli/commands/deploy.py:983, 1111`    - Consider extracting to separate .sql files if refactoring gets complex

**Error**: `Dict entry has incompatible type "str": "set[str]"; expected "str": "str"`    - Or use multi-line string literals with proper indentation

**Fix**: Update dict type annotation to `dict[str, str | set[str]]` or restructure  
**Effort**: 20 minutes  
**Impact**: -2 errors

### T120q: Fix deploy.py set[str] assignment to str variable
**File**: `sqlitch/cli/commands/deploy.py:1723`  
**Error**: `Incompatible types in assignment (set[str] vs str)`  
**Fix**: Fix type annotation or restructure logic  
**Effort**: 20 minutes  
**Impact**: -1 error

---

## Phase 8: CLI Command Type Fixes (16 errors) - Priority P2

### T120r: Fix verify.py EngineTarget type (5 errors)
**File**: `sqlitch/cli/commands/verify.py:246, 256 (2x), 257 (2x)`  
**Errors**:
- Line 246: Assignment type mismatch (EngineTarget vs str | None)
- Line 256-257: union-attr errors accessing .uri and .registry_uri

**Fix**: Fix target variable type annotation to EngineTarget  
**Effort**: 25 minutes  
**Impact**: -5 errors

### T120s: Fix status.py EngineTarget and parse_plan types (3 errors)
**File**: `sqlitch/cli/commands/status.py:128, 134, 204`  
**Errors**:
- Line 128: Assignment type mismatch
- Line 134: Argument type mismatch
- Line 204: parse_plan kwargs type

**Fix**: Align EngineTarget types and fix parse_plan call  
**Effort**: 25 minutes  
**Impact**: -3 errors

### T120t: Fix show.py Tag variable type (5 errors)
**File**: `sqlitch/cli/commands/show.py:150, 151, 153, 155, 156`  
**Error**: Variable declared as `str` but assigned `Tag` object  
**Fix**: Change variable type annotation from str to Tag  
**Effort**: 15 minutes  
**Impact**: -5 errors

### T120u: Fix plan.py _format_path argument type
**File**: `sqlitch/cli/commands/plan.py:271`  
**Error**: `Argument has incompatible type "Path | str | None"; expected "Path | None"`  
**Fix**: Add type narrowing or update function signature  
**Effort**: 15 minutes  
**Impact**: -1 error

### T120v: Fix help.py click.BaseCommand type usage (3 errors)
**File**: `sqlitch/cli/commands/help.py:86, 91, 96`  
**Errors**:
- Line 86: Variable "click.BaseCommand" not valid as type
- Line 91-96: Attribute access errors

**Fix**: Use proper type from Click's type stubs (likely `click.Command`)  
**Effort**: 20 minutes  
**Impact**: -3 errors

### T120w: Fix commands/__init__.py CommandError.show() override
**File**: `sqlitch/cli/commands/__init__.py:66`  
**Error**: `Argument 1 incompatible with supertype (Liskov violation)`  
**Fix**: Align method signature with Click's ClickException.show()  
**Effort**: 20 minutes  
**Impact**: -1 error

---

## Phase 9: Rework & Revert Command Type Fixes (8 errors) - Priority P2

### T120x: Fix rework.py Path | str | None arguments (6 errors)
**File**: `sqlitch/cli/commands/rework.py:200, 207, 214, 220, 221, 222`  
**Error**: `Argument has incompatible type "Path | str | None"; expected "Path | None"`  
**Fix**: Add type narrowing to exclude str from union before function calls  
**Effort**: 30 minutes  
**Impact**: -6 errors

### T120y: Fix revert.py type issues (2 errors)
**File**: `sqlitch/cli/commands/revert.py:185, 752`  
**Errors**:
- Line 185: str | None vs str argument
- Line 752: str | None vs str assignment

**Fix**: Add None checks and type narrowing  
**Effort**: 20 minutes  
**Impact**: -2 errors

---

## Phase 10: Final Cleanup & Validation - Priority P1

### T120z: Update mypy baseline after all fixes
**File**: `tests/test_type_safety.py`  
**Action**: Update `BASELINE_MYPY_ERROR_COUNT` to 0 after all errors fixed  
**Prerequisites**: All T120a-T120y complete  
**Effort**: 5 minutes  
**Impact**: Completes type safety milestone

### T120aa: Document mypy compliance achievement
**File**: `specs/005-lockdown/IMPLEMENTATION_REPORT_LOCKDOWN.md`  
**Action**: Add section documenting achievement of 100% mypy --strict compliance  
**Prerequisites**: T120z complete  
**Effort**: 15 minutes  
**Impact**: Documentation

---

## Execution Strategy

### Recommended Order
1. **Phase 1 (Quick Wins)**: T120a → T120b → T120c
2. **Checkpoint**: Validate 7 errors eliminated (62 → 55)
3. **Phase 2**: T120d → T120e
4. **Checkpoint**: Validate 4 errors eliminated (55 → 51)
5. **Phase 3**: T120f → T120g → T120h
6. **Checkpoint**: Validate 6 errors eliminated (51 → 45)
7. **Phases 4-9**: Execute in order, validating after each task
8. **Phase 10 Final**: T120z → T120aa

### Validation Protocol
After each task:
```bash
source .venv/bin/activate
mypy --strict sqlitch/ 2>&1 | grep "^Found" 
pytest tests/test_type_safety.py -v
```

Expected progression:
- Start: 62 errors
- After Phase 1: 55 errors  
- After Phase 2: 51 errors
- After Phase 3: 45 errors
- After Phase 4: 43 errors
- After Phase 5: 38 errors
- After Phase 6: 35 errors
- After Phase 7: 30 errors
- After Phase 8: 14 errors
- After Phase 9: 6 errors
- Final: 0 errors ✅

### Test Suite Validation
After each phase, run:
```bash
pytest --tb=short
```
Ensure no regressions (1112+ tests passing).

---

## Summary

- **Total Tasks**: 27 granular tasks (T120a - T120aa)
- **Total Errors to Fix**: 62
- **Estimated Total Effort**: ~8-10 hours
- **Priority Distribution**:
  - P1 (Critical): 17 errors across 7 tasks
  - P2 (Important): 45 errors across 18 tasks
  - P1 (Final): 2 documentation tasks

Each task is atomic, testable, and completes in ≤30 minutes.
